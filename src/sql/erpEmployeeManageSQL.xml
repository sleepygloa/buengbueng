<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC '-//ibatis.apache.org//DTD Sql Map 2.0//EN' 'http://ibatis.apache.org/dtd/sql-map-2.dtd'>
<sqlMap namespace="erpEmp">

	<resultMap id="userDtoMap" class="login.user.bean.UserInfoDataDTO">
         <result property="id" column="id" />
         <result property="pw" column="pw" nullValue="1234"/>
         <result property="name" column="name" nullValue="none"/>
         <result property="birth" column="birth" nullValue="170606"/>
         <result property="phone" column="phone" nullValue="010-0000-0000"/>
         <result property="address" column="address" nullValue="none"/>
         <result property="email" column="email" nullValue="none"/>
         <result property="googleId" column="googleId" nullValue="none"/>
    </resultMap>

	
<!-- 알바생 관리 하는 부분 -->
	
	<!-- 알바생신청 로그의 제일 마지막 번호를 불러온다. 신청 폼의 신청 번호 -->
	<select id="getEmployeeAddLogLastNum" resultClass="beDto">
		select num, (select count(*) FROM employeeInfo WHERE e_bossid = #e_bossid#) AS count from employeeAddLog order by num desc limit 0, 1;
	</select>
	
	<!-- 사장님이 알바원하는 인원수만큼 신청(삭제도가능) -->
	<insert id="insertEmployeeAddLog" parameterClass="beDto">
		INSERT INTO employeeAddLog (num, result, b_id, applyCount, applyTime, content)
							 VALUES(0, 0, #b_id#, #applyCount#, now(), #content#);
	</insert>
	
	<!-- 알바생 정보테이블에서 사장님이 보유한 알바생아이디를 찾고, 갯수를 센다. -->
	<select id="getEmployeeId" resultClass="beDto" parameterClass="String">
		SELECT e_id, (select count(*) FROM employeeInfo WHERE e_bossid = #e_bossid#) +1 AS count FROM employeeInfo WHERE e_bossid = #e_bossid# ORDER BY e_id DESC LIMIT 1; 
	</select>	
	
	<!-- 알바생 정보테이블에서 사장님이 보유한 알바생아이디를 찾고, 갯수를 센다. -->
	<select id="getEmployeeAddLog" resultClass="beDto" >
		SELECT * from  employeeAddLog where result = '0';
	</select>		
	
	<!-- 알바생아이디를 생성하고자할때, 아이디가 중간에없는 아이디를 찾는다. -->
	<select id="findE_idNull" resultClass="String" parameterClass="String">
		select e_id from employeeInfo where e_id = #e_id#;
	</select>
	
	<!-- 알바생 아이디를 회원테이블 생성 -->
	<insert id="insertEmployeeIdUserInfo" parameterClass="String">
		INSERT INTO userInfo (id, pw, grade, signdate) VALUES(#e_id#, 1234, 2, now());
	</insert>
	
	<!-- 알바생 아이디를  알바생정보테이블에 생성 -->
	<insert id="insertEmployeeIdEmployeeInfo" parameterClass="java.util.HashMap">
		INSERT INTO employeeInfo (e_id, e_bossid) VALUES(#e_id#, #e_bossid#);
	</insert>		
	
	<!-- 아이디 신청한 수만큼 아이디 생성이 완료되면, 아이디 신청 컨펌 정보를 업데이트한다. -->
	<update	id="updateEmployeeAddLog" parameterClass="String">
		update employeeAddLog set result = 1, confirmTime = now(), e_id = #id#; 
	</update>

	
	<!-- 알바생 리스트 -->
	<select id="getEmployeeList" resultClass="beDto" parameterClass="String">
		select e_id, pw, name AS e_name from userInfo a INNER JOIN 
		(select e_id from employeeInfo where e_bossid = #id#) b on a.id = b.e_id;
	</select>
	
<!-- ▲▼ 처리 구문 ======================== -->
	<!-- 새로운 공간을 만들어준다 -->
	<select id="getListNum" resultClass="int" parameterClass="String">
		select num from employeeInfo where e_bossid = #b_id#;
	</select>
	
	<!-- 앞번호에 space를 넣어준다. space = 9999 -->
	<update id="changeSpace" parameterClass="java.util.HashMap">
		update employeeInfo set num = #space# where num = #numb#;
	</update>
	
	<!-- 앞번호에 변경될 수를 넣어준다. -->
	<update id="changeBefore" parameterClass="java.util.HashMap">
		update employeeInfo set num = #numb# where num = #numa#;
	</update>
	
	<!-- 뒷번호에 변경될 수를 넣어준다. -->
	<update id="changeAfter" parameterClass="java.util.HashMap">
		update employeeInfo set num = #numa# where num = #space#;
	</update>	
<!-- 끝  -->
	
	<!-- 알바생 아이디로 정보를 볼러옴 AJAX-->
	<select id="getEmployeeInfo" resultClass="userDto" parameterClass="int">
		select * from userInfo a INNER JOIN (select e_id from employeeInfo where num = #num#) b on a.id = b.e_id;
	</select>	
	
	<!-- 알바생 아이디로 회원정보를 볼러옴 AJAX-->
	<select id="getEmployeeUpdateInfo" resultClass="userDto" parameterClass="String">
		select * from userInfo where id = #id#;
	</select>
	
	
	
	
	
	
	
	
	
	
	
	<!-- 알바생아이디는 있지만 보스아이디가 없는 것을 찾음 -->
	<select id="findBossIdNull" resultClass="String">
		SELECT e_id from employeeInfo where e_bossid = '' ORDER BY e_id desc limit 0, 1; 
	</select>
	

		
	<!-- 사장님이 아이디를 원하는 수만큼 신청 . 관리자의 승낙을 받아야한다. -->
	<insert id="employeeAddLog" parameterClass="beDto">
		INSERT INTO employeeAddLog (num, b_id,  applyTime, content) VALUES(0, #b_id#,  now());
	</insert>







	

	<!-- 새로만들 알바아이디가 userInfo에 있는지 검색 -->
	<select id="findEmployeeIdUserId" parameterClass="String">
		select * from userInfo where id = #e_id#;
	</select>
	
	<!-- 사장아이디만 있는 것을 검색 -->
	<select id="findEmployeeInfoNullBossId" resultClass="String" parameterClass="String">
		select e_id from employeeInfo where e_id = '' and e_bossid = #e_bossid# Limit 0,1;
	</select>
	
	<!--  -->
	<update id="updateEmployeeInfoNullBossId" parameterClass="String">
		update employeeInfo set e_id = #e_id# where e_id = '' and e_bossid = #e_bossid#;
	</update>
	


	

	<!-- 알바생아이디 있고, 보스 아이디도 있는 것 중 가장 높은 번호를 찾음 -->
	<select id="findBossIdNotNull" resultClass="String">
		SELECT e_id from employeeInfo where e_bossid = #e_bossid# ORDER BY e_id desc; 
	</select>
	
	<!-- 삭제할 알바생 아이디의 정보를 찾는다.-->
	<select id="findDeleteId" resultClass="String" parameterClass="String">
		select pw from userInfo where id = #e_id#;
	</select>

	<!-- 알바생 아이디를 삭제한다..-->
	<delete id="deleteEmployeeId" parameterClass="String">
		delete from employeeInfo where e_id = #e_id#;
	</delete>

	<!-- 알바생 아이디를 삭제한다..-->
	<delete id="deleteUserId" parameterClass="String">
		delete from userInfo where id = #e_id#;
	</delete>	
	
	<!-- 알바생 아이디 수 반환-->
	<select id="getEmployeeIdCount" resultClass="int" parameterClass="String">
		select count(*) from employeeInfo where e_bossid = #e_bossid#;
	</select>
	
	<!-- 알바생 아이디 정보 리스트-->
	<select id="getEmployeeIdInfoList" resultMap="userDtoMap" parameterClass="java.util.HashMap">
		select * from userInfo where id = (select e_id from employeeInfo where e_bossid = #id# LIMIT #i#, 1);
	</select>
	
	

	<!-- 알바생 아이디로 정보 수정-->
	<update id="updateEmployeeId"  parameterClass="userDto">
		UPDATE userInfo SET 
			pw = #pw#,
			name = #name#,
			birth = #birth#,
			phone = #phone#,
			email = #email#,
			address = #address#
		WHERE id = #id#;
	</update>	

	<!-- 알바생 접속 LOG 찾기 -->
	<select id="findLoginLogLogoutNull"  parameterClass="String">
		SELECT count(*) from useTimeLog WHERE id = #id# ORDER BY loginTime desc;
	</select>

	<!-- 알바생 접속 LOG 추가 -->
	<insert id="insertEmployeeLoginLog" parameterClass="java.util.HashMap">
		INSERT INTO useTimeLog (id, loginTime, ip) VALUES(#id#, now(), #ip#);
	</insert>
	
	<!-- 알바생 접속해제 LOG 변경 -->
	<update id="updateEmployeeLogoutLog" parameterClass="String">
		update useTimeLog set logoutTime = now() where id = #id# order by loginTime desc limit 1
	</update>

	<!-- 알바생 접속 LOG LIST Count -->
	<select id="getEmployeeLoginLogoutLogListCount" resultClass="int" parameterClass="String">
		select count(*) from useTimeLog u,(select e_id from employeeInfo where e_bossid = #id#) e where u.id = e.e_id ORDER BY logoutTime desc;
	</select>	

	<!-- 알바생 접속 LOG LIST  -->
	<select id="getEmployeeLoginLogoutLogList" resultClass="useTimeDto" parameterClass="java.util.HashMap">
		<![CDATA[
			select id, loginTime, logoutTime, ip, r from 
			(select id, loginTime, logoutTime, ip, @rownum:=@rownum + 1 as r from
			(select u.id, u.loginTime, u.logoutTime, u.ip from useTimeLog u,
			(select e_id from employeeInfo where e_bossid = #id#) e 
			where u.id = e.e_id ORDER BY logoutTime desc) b, (select @rownum:=0) TMP) c	
			where r >= #startRow# and r <= #endRow# ;
		]]>
	</select>	

	<!-- 사장님 총 통계 -->
	
	<!-- 사장님  알바생 일한 시간 계산 -->
	<select id="employeeWorkCount" resultClass="bossErpTotalDTO" parameterClass="java.util.HashMap">
		<![CDATA[
		select (case when id = 1 then 'hello' else id end) as id,
		date_format(loginTime, "%Y-%m-%d") AS loginTime, sum(round(logoutTime - loginTime)) as count 
		from useTimeLog as a INNER JOIN employeeInfo as b ON a.id = b.e_id 
		where loginTime >= #minDate# and loginTime <= #maxDate#
		group by id with rollup;
		]]>
	</select>
	
</sqlMap>
	