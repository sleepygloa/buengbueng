<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC '-//ibatis.apache.org//DTD Sql Map 2.0//EN' 'http://ibatis.apache.org/dtd/sql-map-2.dtd'>
<sqlMap namespace="customer">

	<resultMap class="int" id="intnull">
		<result property="num" column="num" nullValue="0"/>
	</resultMap>
	
	<!-- 게시판의 총 게시글 -->
	<select id="customercount" parameterClass="int" resultClass="int">
		select count(*) from customerBoard where snum=#snum#;
	</select>
	
	<!-- 게시판 리스트 -->
	<select id="customerlist" parameterClass="java.util.HashMap" resultClass="customerDTO">
		<![CDATA[
		select num,snum,title,content,passwd,writer,email,reg_date,ref,re_step,readcount,@rownum:=@rownum+1 as rownum
		from (SELECT num,snum,title,content,passwd,writer,email,reg_date,ref,re_step,readcount
		from (SELECT num,snum,title,content,passwd,writer,email,reg_date,ref,re_step,readcount
		from customerBoard,(select @rownum:=0)r WHERE snum=#snum# order by ref desc, re_step asc limit #startRow#,#pageSize#)a order by ref desc, re_step asc)b;
		]]>
	</select>
	
	<!-- 게시판  num의 최대 값 -->
	<select id="maxNum" parameterClass="int" resultMap="intnull">
		select max(num) as num from customerBoard where snum=#snum# and re_step=0;
	</select>
	
	<!-- 글 작성 -->
	<insert id="writePro" parameterClass="customerDTO">
		insert into customerBoard(snum,title,content,passwd,writer,email,reg_date,ref,re_step) 
		values(#snum#,#title#,#content#,#passwd#,#writer#,#email#,now(),#ref#,#re_step#);
	</insert>
	
	<!-- 조회수 증가 -->
	<update id="contentUp" parameterClass="java.util.HashMap">
		update customerBoard set readcount=readcount+1 where num= #num# and snum=#snum#
	</update>
	
	<!-- 게시글 불러오기 -->
	<select id="getContent" parameterClass="java.util.HashMap" resultClass="customerDTO">
		select * from customerBoard where snum=#snum# and num=#num#
	</select>
	
	<!-- 답글 여부 확인 -->
	<select id="getReply" parameterClass="java.util.HashMap" resultClass="int">
		select count(*) from customerBoard where ref=#ref# and snum=#snum#;
	</select>
		
	<!-- 글 비밀번호 조회 -->
	<select id="getPasswd" parameterClass="java.util.HashMap" resultClass="String">
		select passwd from customerBoard where num=#num# and snum=#snum#;
	</select>
	
	<!-- 게시글과 댓글 구분값 조회 -->
	<select id="getRe_step" parameterClass="java.util.HashMap" resultClass="int">
		select re_step from customerBoard where num=#num# and snum=#snum#;
	</select>
	
	<!-- 게시글 그룹 검색 -->
	<select id="getRef" parameterClass="java.util.HashMap" resultClass="int">
		select ref from customerBoard where num=#num# and snum=#snum#
	</select>
	
	<!-- 게시글과 답글 삭제 -->
	<delete id="delRef" parameterClass="java.util.HashMap">
	<![CDATA[
		delete from customerBoard where ref=#ref# and re_step>=#re_step# and snum=#snum#
	]]>
	</delete>
	
	<!-- 게시글 내용 수정 -->
	<update id="modifyContent" parameterClass="customerDTO">
		update customerBoard set email=#email#,title=#title#,content=#content# where num=#num# and snum=#snum#
	</update>
	
	<!-- 관리자 글 삭제 -->
	<delete id="bossDel" parameterClass="java.util.HashMap">
	<![CDATA[
		delete from customerBoard where ref=#ref# and re_step>=#re_step# and snum=#snum#;
	]]>
	</delete>
</sqlMap>