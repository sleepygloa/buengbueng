<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC '-//ibatis.apache.org//DTD Sql Map 2.0//EN' 'http://ibatis.apache.org/dtd/sql-map-2.dtd'>
<sqlMap namespace="customer">
	<typeAlias alias="customerDTO" type="login.user.bean.CustomerDTO"/>
	
	<resultMap class="int" id="intnull">
		<result property="num" column="num" nullValue="0"/>
	</resultMap>
	
	<!-- 게시판의 총 게시글 -->
	<select id="customercount" parameterClass="int" resultClass="int">
		SELECT count(*) FROM customerBoard WHERE snum=#snum#;
	</select>
	
	<!-- 게시판 리스트 -->
	<select id="customerlist" parameterClass="java.util.HashMap" resultClass="customerDTO">
		<![CDATA[
		SELECT num,snum,title,content,passwd,writer,email,reg_date,ref,re_step,readcount,@rownum:=@rownum+1 as rownum
		FROM (SELECT num,snum,title,content,passwd,writer,email,reg_date,ref,re_step,readcount
		FROM (SELECT num,snum,title,content,passwd,writer,email,reg_date,ref,re_step,readcount
		FROM customerBoard,(select @rownum:=0)r WHERE snum=#snum# order by ref desc, re_step asc limit #startRow#,#pageSize#)a order by ref desc, re_step asc)b;
		]]>
	</select>
	
	<!-- 게시판  num의 최대 값 -->
	<select id="maxNum" parameterClass="int" resultMap="intnull">
		select max(num) as num from customerBoard where snum=#snum# and re_step=0;
	</select>
	
	<!-- 기존 게시글 업뎃 -->
	<update id="writeUp" parameterClass="java.util.HashMap">
		<![CDATA[
		update customerBoard set ref=#ref# where ref=#ref# and re_step>#re_step# and snum=#snum#;
		]]>
	</update>
	
	<!-- 글 작성 -->
	<insert id="writePro" parameterClass="customerDTO">
		insert into customerBoard(snum,title,content,passwd,writer,email,reg_date,ref,re_step) 
		values(#snum#,#title#,#content#,#passwd#,#writer#,#email#,now(),#ref#,#re_step#);
	</insert>
	
	<!-- 조회수 증가 -->
	<update id="contentUp" parameterClass="java.util.HashMap">
		update customerBoard set readcount=readcount+1 where num= #num# and snum=#snum#
	</update>
	
	<!-- 게시글 -->
	<select id="getContent" parameterClass="java.util.HashMap" resultClass="customerDTO">
		select * from customerBoard where snum=#snum# and num=#num#
	</select>
	
	<!-- 글 비밀번호 조회 -->
	<select id="getPasswd" parameterClass="java.util.HashMap" resultClass="String">
		select passwd from customerBoard where num=#num# and snum=#snum#;
	</select>
	
	<!-- 해당 글과 답글 검색 -->
	<select id="getRef" parameterClass="java.util.HashMap" resultClass="int">
		select ref from customerBoard where num=#num# and snum=#snum#
	</select>
	
	<!-- 해당 글과 답글 삭제 -->
	<delete id="delRef" parameterClass="int">
		delete from customerBoard where ref=#ref#
	</delete>
</sqlMap>