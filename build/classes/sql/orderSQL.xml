<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC '-//ibatis.apache.org//DTD Sql Map 2.0//EN' 'http://ibatis.apache.org/dtd/sql-map-2.dtd'>
<sqlMap namespace="order"> 	
	
	<!-- 사용자와 사장님이 주문시 주문현황 SQL -->
	
	
	<!-- 사용자가 로그인하는 피씨방 정보 가져오는 sql -->
	<select id="selectFranchisee" resultClass="franchiseeDTO">
		select * from franchiseeInfo;
	</select>
	
	<!-- 가맹점이름으로 그 가맹점 라이센스 키 가져오기 -->
	<select id="getLicenseKey" parameterClass="String" resultClass="String">
		select b_key from franchiseeInfo where b_name=#b_name#;
	</select>
	
	
	<!-- MenuOrderPro 에서 주문한 메뉴와 그 메뉴의 재고판매현황이 1인 재고를 꺼내는 sql -->
	<select id="selectProduct" parameterClass="java.util.HashMap" resultClass="int">
		select count(*) from product where name=#order# and l_key=#l_key# and salecheck=1;
	</select>
	
	<!-- MenuOrderPro 에서 주문했을때 사장주문리스트에 벌써들어가있는 재고를 말하는것 sql -->
	<select id="selectMenuOrder" parameterClass="java.util.HashMap" resultClass="int">
		select count(*) from menuOrder where menuname=#order# and l_key=#l_key# and orderstatus=1;
	</select>

	
	<!-- 주문 갯수 -->
	<select id="orderCount" parameterClass="String" resultClass="int">
	<![CDATA[
		select count(*) from menuOrder where ordertime<=now() and l_key=#l_key#;
	]]>
	</select>	
	
	<!-- order의 메뉴이름을 가지고 가격을 가져옴 -->
	<select id="getPrice" parameterClass="java.util.HashMap" resultClass="int">
		select price from menu where name=#order# and l_key=#l_key#;
	</select> 
	
	
	<!-- 주문재고 있으면 주문현황에 추가 -->	
	<insert id="insertMenuOrder" parameterClass="java.util.HashMap">
		insert into menuOrder values(#num#,#id#,#menuname#,now(),#orderstatus#,#ordermoney#,#l_key#);
	</insert>
	
	<!-- 사용자가 주문한 내역을 사장이 열어 볼 리스트. 주문현황리스트 -->
	<select id="getMenuOrder" parameterClass="String" resultClass="orderDto">
		select * from menuOrder where l_key=#l_key#;
	</select>
	
	<!-- 받은 바코드가 메뉴이름과 일치하며 판매유무가 1이라면 주문완료-->
	<select id="salecheckCheck" parameterClass="java.util.HashMap" resultClass="productDto">
		select * from product where code=#barcode# and name=#name# and salecheck=1 and l_key=#l_key#;
	</select>
	
	<!--주문현황 주문중에서 주문완료로 바꾸기 위함-->
	<update id="updateStatus" parameterClass="java.util.HashMap">
		update menuOrder set orderstatus=2 where num=#num# and l_key=#l_key#;
	</update>
	
	<!-- 재고 판매여부 1에서 0으로 판매되었음을 알리기 위함 -->
	<update id="updateSaleCheck" parameterClass="java.util.HashMap">
		update product set salecheck=0 where name=#name# and code=#barcode# and l_key=#l_key#;
	</update>
	
	<!-- sellBuyLog에 재고 판매시점 입력 -->
	<update id="productsaleregistdate" parameterClass="java.util.HashMap">
		update sellBuyLog set productsaleregistdate=now() where name=#name# and code=#barcode# and l_key=#l_key#;
	</update>
	
	

</sqlMap>