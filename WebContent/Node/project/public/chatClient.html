<html>
  <head>
	<meta charset="UTF-8">
    <title>챗봇</title>
    <link rel="stylesheet" type="text/css" href="./chatClient.css">
	<script type='text/javascript' src='https://code.jquery.com/jquery-3.2.1.min.js'></script>
    <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.1/socket.io.js'></script>
	<script type='text/javascript' src='block.js'></script>
    <script type='text/javascript'>
    //  var socket = io.connect('ws://192.168.0.206:3000');
      var socket = io.connect('ws://localhost:3000');
      $(document).ready(function(){
        // 입력버튼 누르면 발생
        $('#submitBtn').click(function(){
          var keyword = "";
          // 사용자 질문 채팅창에 띄우기
          var txt = $('#chat').html();
		  var userTxt = $('#userTxt').val().replace("\n","<br/>");
          $('#chat').html(
		  		txt+"<div class='line'>"+
						"<div class='user'>사용자<br/>"+
							"<div class='question'>"+
								userTxt+
							"</div>"+
						"</div>"+
					"</div>"
		  );
          var question =  document.getElementById("userTxt").value;
          // 사용자의 질문에서 키워드 추출하기
          $.ajax({
        		url:"http://api.datamixi.com/datamixiApi/keywordextract",
        		contentType: "application/x-www-form-urlencoded; charset=UTF-8",
        		type:"POST",
        		dataType:'text',
        		data: {
        			request:'post',
        			key:'7173114780022473721',
        			text: question
        		},
            success: function(data){
        			var parser = JSON.parse(data);
        			for(i=0;i<parser.return_object.length;i++){
        				var last = parser.return_object[i].term.indexOf('|');
        				keyword += parser.return_object[i].term.substring(0,last);
                if(i != parser.return_object.length-1){
                  keyword  += ",";
                }
        			}
              socket.emit('chat', keyword,question);
        		}
        	});
          socket.on('recieveChat',function(data){
            var txt = $('#chat').html();
            $('#chat').html(
				txt+"<div class='line'>"+
						"<div class='admin'>관리자<br/>"+
							"<div class='answer'>"+
								data+
							"</div>"+
						"</div>"+
					"</div>"
			);
            socket.end();
          });
        });
      });
    </script>
  </head>
  <body>
    <h2>무엇을 도와드릴까요</h2>
    <div class='chatbot'>
		<div id='chat'>
			<div class='line'>
				<div class='admin'>관리자<br/>
					<div class='answer'>
						안녕하세요. 무엇을 도와드릴까요?
					</div>
				</div>
			</div>
		</div>
		<div class='inputDiv'>
			<textArea id='userTxt' placeholder='입력란'></textArea>
			<div class='btnDiv'>
				<button id='submitBtn'>전송</button>
			</div>
		</div>
	</div>
  </body>
</html>
